"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Utils = void 0;
const child_process_1 = __importDefault(require("child_process"));
const crypto_1 = __importDefault(require("crypto"));
const fs_extra_1 = __importDefault(require("fs-extra"));
const path_1 = __importDefault(require("path"));
const Logger_1 = require("./Logger");
class Utils {
    static get ProjectPath() {
        if (!this.projectPath)
            this.projectPath = this.toUniSeparator(Editor.Project.path);
        return this.projectPath;
    }
    /** 是否原生平台 */
    static isNative(platform) {
        switch (platform) {
            case "windows":
            case "mac":
            case "linux":
            case "android":
            case "ios":
                return true;
        }
        return false;
    }
    /** 是否小游戏平台 */
    static isMinigame(platform) {
        switch (platform) {
            case "wechatgame":
            case "alipay-mini-game":
            case "bytedance-mini-game":
            case "baidu-mini-game":
            case "taobao-creative-app":
                return true;
        }
        return false;
    }
    /** 执行终端命令 */
    static exeCMD(workDir, cmd, onMsg) {
        let p = new Promise((resolve, reject) => {
            let result = child_process_1.default.exec(cmd, { cwd: workDir });
            result.stdout.on("data", (data) => {
                let d = data.toString();
                onMsg && onMsg(d);
                if (d.indexOf("continue") > -1) {
                    result.kill();
                }
            });
            result.stderr.on("data", (data) => {
                if (globalThis['Editor']) {
                    Logger_1.Logger.error(data.toString());
                }
                else {
                    Logger_1.Logger.error(data.toString());
                }
            });
            result.on("close", (code) => {
                resolve(code ? code : 0);
            });
        });
        return p;
    }
    /** 获取指定目录下所有文件 */
    static getAllFiles(dir, filter, topDirOnly = false) {
        dir = this.toAbsolutePath(dir);
        let files = [];
        if (!fs_extra_1.default.existsSync(dir))
            return files;
        let walkSync = (currentDir, callback) => {
            fs_extra_1.default.readdirSync(currentDir, { withFileTypes: true }).forEach(dirent => {
                let p = path_1.default.join(currentDir, dirent.name);
                if (dirent.isFile()) {
                    callback(p);
                }
                else if (dirent.isDirectory()) {
                    if (topDirOnly)
                        return;
                    walkSync(p, callback);
                }
            });
        };
        walkSync(dir, file => {
            if (file.endsWith(".meta"))
                return;
            if (!filter || filter(file)) {
                files.push(this.toUniSeparator(file));
            }
        });
        return files;
    }
    /** 获取指定目录下所有目录 */
    static getAllDirs(dir, filter, topDirOnly = false) {
        dir = this.toAbsolutePath(dir);
        let dirs = [];
        if (!fs_extra_1.default.existsSync(dir))
            return dirs;
        let walkSync = (currentDir, callback) => {
            fs_extra_1.default.readdirSync(currentDir, { withFileTypes: true }).forEach(dirent => {
                let p = path_1.default.join(currentDir, dirent.name);
                if (dirent.isDirectory()) {
                    callback(p);
                    if (topDirOnly)
                        return;
                    walkSync(p, callback);
                }
            });
        };
        walkSync(dir, subDir => {
            if (!filter || filter(subDir)) {
                dirs.push(this.toUniSeparator(subDir));
            }
        });
        return dirs;
    }
    /** 根据文件路径找到追加了Md5值的实际文件路径 */
    static resolveFilePath(filePath) {
        let result = filePath;
        let dir = path_1.default.dirname(filePath);
        if (fs_extra_1.default.existsSync(dir)) {
            let basename = path_1.default.basename(filePath);
            let ext = path_1.default.extname(filePath);
            let name = basename.replace(ext, ".");
            let reg = new RegExp(`${name}[A-Za-z0-9]{5}${ext}`);
            let dirents = fs_extra_1.default.readdirSync(dir, { withFileTypes: true });
            for (const dirent of dirents) {
                let p = path_1.default.join(dir, dirent.name);
                if (dirent.isFile()) {
                    if (dirent.name == basename) {
                        break;
                    }
                    else {
                        if (reg.test(dirent.name)) {
                            result = p;
                            break;
                        }
                    }
                }
            }
        }
        return this.toUniSeparator(result);
    }
    /** 将追加了Md5的文件路径还原为正常的文件路径 */
    static restoreFilePath(filePath) {
        let ext = path_1.default.extname(filePath);
        let p = filePath.replace(ext, "");
        let reg = new RegExp(/.+\.[A-Za-z0-9]{5}/);
        if (reg.test(p)) {
            let index = p.lastIndexOf(".");
            return p.substring(0, index) + ext;
        }
        else {
            return filePath;
        }
    }
    /** 修改文件名，使其文件名后追加Md5值 */
    static appendMd5(filePath) {
        if (fs_extra_1.default.existsSync(filePath)) {
            let ext = path_1.default.extname(filePath);
            let p = filePath.replace(ext, "");
            let reg = new RegExp(/.+\.[A-Za-z0-9]{5}/);
            if (!reg.test(p)) {
                let md5 = crypto_1.default.createHash('md5').update(fs_extra_1.default.readFileSync(filePath)).digest('hex');
                let shortMd5 = md5.substring(0, 6);
                let newFilePath = p + "." + shortMd5 + ext;
                fs_extra_1.default.renameSync(filePath, newFilePath);
            }
        }
    }
    /** 修改文件名，移除其文件名后的Md5值 */
    static removeMd5(filePath) {
        if (fs_extra_1.default.existsSync(filePath)) {
            let newFilePath = this.restoreFilePath(filePath);
            fs_extra_1.default.renameSync(filePath, newFilePath);
        }
    }
    /** 刷新编辑器内的资源 */
    static refreshAsset(path) {
        if (!path.startsWith("db:") && fs_extra_1.default.statSync(path).isDirectory()) {
            let files = Utils.getAllFiles(path, null, true);
            for (const file of files) {
                Editor.Message.send("asset-db", "refresh-asset", this.toAssetDBUrl(file));
            }
        }
        else {
            Editor.Message.send("asset-db", "refresh-asset", this.toAssetDBUrl(path));
        }
    }
    /** 删除编辑器内的资源 */
    static deleteAsset(path) {
        Editor.Message.send("asset-db", "delete-asset", this.toAssetDBUrl(path));
    }
    /** 将本地文件路径转化为编辑器内资源路径 */
    static toAssetDBUrl(path) {
        if (path.startsWith("db://"))
            return path;
        else
            return path.replace(this.ProjectPath + "/", "db://");
    }
    /** 将编辑器内资源路径转化为本地文件路径 */
    static toAbsolutePath(dbUrlOrprojUrl) {
        if (dbUrlOrprojUrl.startsWith("db://"))
            return dbUrlOrprojUrl.replace("db://", this.ProjectPath + "/");
        else if (dbUrlOrprojUrl.startsWith("project://"))
            return dbUrlOrprojUrl.replace("db://", this.ProjectPath + "/");
        else
            return dbUrlOrprojUrl;
    }
    /** 统一路径分隔符为(/) */
    static toUniSeparator(path) {
        return path.replace(/\\/g, "/");
    }
    /** 统一换行符为(\n) */
    static toUniLineBrake(content) {
        return content.replace(/\\r\\n/g, "\n");
    }
    /** 获取文件或者目录所在的bundle路径 */
    static getBundlePath(filePath) {
        var _a;
        filePath = this.toUniSeparator(filePath);
        let dir = path_1.default.dirname(filePath);
        while (true) {
            let meta = dir + ".meta";
            if (fs_extra_1.default.existsSync(meta)) {
                let obj = fs_extra_1.default.readJsonSync(meta);
                if ((_a = obj === null || obj === void 0 ? void 0 : obj.userData) === null || _a === void 0 ? void 0 : _a.isBundle) {
                    return dir;
                }
                else {
                    dir = path_1.default.dirname(dir);
                    if (dir == this.projectPath)
                        break;
                }
            }
            else {
                break;
            }
        }
        return null;
    }
}
exports.Utils = Utils;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zb3VyY2UvdG9vbHMvVXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsa0VBQTBDO0FBQzFDLG9EQUE0QjtBQUM1Qix3REFBMEI7QUFDMUIsZ0RBQXdCO0FBQ3hCLHFDQUFrQztBQUNsQyxNQUFhLEtBQUs7SUFHUCxNQUFNLEtBQUssV0FBVztRQUN6QixJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVc7WUFBRSxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNuRixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUM7SUFDNUIsQ0FBQztJQUVELGFBQWE7SUFDTixNQUFNLENBQUMsUUFBUSxDQUFDLFFBQWdCO1FBQ25DLFFBQVEsUUFBUSxFQUFFO1lBQ2QsS0FBSyxTQUFTLENBQUM7WUFDZixLQUFLLEtBQUssQ0FBQztZQUNYLEtBQUssT0FBTyxDQUFDO1lBQ2IsS0FBSyxTQUFTLENBQUM7WUFDZixLQUFLLEtBQUs7Z0JBQ04sT0FBTyxJQUFJLENBQUM7U0FDbkI7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDO0lBRUQsY0FBYztJQUNQLE1BQU0sQ0FBQyxVQUFVLENBQUMsUUFBZ0I7UUFDckMsUUFBUSxRQUFRLEVBQUU7WUFDZCxLQUFLLFlBQVksQ0FBQztZQUNsQixLQUFLLGtCQUFrQixDQUFDO1lBQ3hCLEtBQUsscUJBQXFCLENBQUM7WUFDM0IsS0FBSyxpQkFBaUIsQ0FBQztZQUN2QixLQUFLLHFCQUFxQjtnQkFDdEIsT0FBTyxJQUFJLENBQUM7U0FDbkI7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDO0lBRUQsYUFBYTtJQUNOLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBZSxFQUFFLEdBQVcsRUFBRSxLQUE2QjtRQUM1RSxJQUFJLENBQUMsR0FBRyxJQUFJ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LElBQUksR0FBRyxHQUFHLGNBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDakMsT0FBTyxJQUFJLEVBQUU7WUFDVCxJQUFJLElBQUksR0FBRyxHQUFHLEdBQUcsT0FBTyxDQUFDO1lBQ3pCLElBQUksa0JBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUU7Z0JBQ3JCLElBQUksR0FBRyxHQUFHLGtCQUFFLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNoQyxJQUFJLE1BQUEsR0FBRyxhQUFILEdBQUcsdUJBQUgsR0FBRyxDQUFFLFFBQVEsMENBQUUsUUFBUSxFQUFFO29CQUN6QixPQUFPLEdBQUcsQ0FBQztpQkFDZDtxQkFBTTtvQkFDSCxHQUFHLEdBQUcsY0FBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztvQkFDeEIsSUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLFdBQVc7d0JBQUUsTUFBTTtpQkFDdEM7YUFDSjtpQkFBTTtnQkFDSCxNQUFNO2FBQ1Q7U0FDSjtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7Q0FDSjtBQXpPRCxzQkF5T0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2hpbGRfcHJvY2VzcyBmcm9tIFwiY2hpbGRfcHJvY2Vzc1wiO1xuaW1wb3J0IGNyeXB0byBmcm9tIFwiY3J5cHRvXCI7XG5pbXBvcnQgZnMgZnJvbSBcImZzLWV4dHJhXCI7XG5pbXBvcnQgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0IHsgTG9nZ2VyIH0gZnJvbSBcIi4vTG9nZ2VyXCI7XG5leHBvcnQgY2xhc3MgVXRpbHMge1xuXG4gICAgcHJpdmF0ZSBzdGF0aWMgcHJvamVjdFBhdGg6IHN0cmluZztcbiAgICBwdWJsaWMgc3RhdGljIGdldCBQcm9qZWN0UGF0aCgpIHtcbiAgICAgICAgaWYgKCF0aGlzLnByb2plY3RQYXRoKSB0aGlzLnByb2plY3RQYXRoID0gdGhpcy50b1VuaVNlcGFyYXRvcihFZGl0b3IuUHJvamVjdC5wYXRoKTtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvamVjdFBhdGg7XG4gICAgfVxuXG4gICAgLyoqIOaYr+WQpuWOn+eUn+W5s+WPsCAqL1xuICAgIHB1YmxpYyBzdGF0aWMgaXNOYXRpdmUocGxhdGZvcm06IHN0cmluZykge1xuICAgICAgICBzd2l0Y2ggKHBsYXRmb3JtKSB7XG4gICAgICAgICAgICBjYXNlIFwid2luZG93c1wiOlxuICAgICAgICAgICAgY2FzZSBcIm1hY1wiOlxuICAgICAgICAgICAgY2FzZSBcImxpbnV4XCI6XG4gICAgICAgICAgICBjYXNlIFwiYW5kcm9pZFwiOlxuICAgICAgICAgICAgY2FzZSBcImlvc1wiOlxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvKiog5piv5ZCm5bCP5ri45oiP5bmz5Y+wICovXG4gICAgcHVibGljIHN0YXRpYyBpc01pbmlnYW1lKHBsYXRmb3JtOiBzdHJpbmcpIHtcbiAgICAgICAgc3dpdGNoIChwbGF0Zm9ybSkge1xuICAgICAgICAgICAgY2FzZSBcIndlY2hhdGdhbWVcIjpcbiAgICAgICAgICAgIGNhc2UgXCJhbGlwYXktbWluaS1nYW1lXCI6XG4gICAgICAgICAgICBjYXNlIFwiYnl0ZWRhbmNlLW1pbmktZ2FtZVwiOlxuICAgICAgICAgICAgY2FzZSBcImJhaWR1LW1pbmktZ2FtZVwiOlxuICAgICAgICAgICAgY2FzZSBcInRhb2Jhby1jcmVhdGl2ZS1hcHBcIjpcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLyoqIOaJp+ihjOe7iOerr+WRveS7pCAqL1xuICAgIHB1YmxpYyBzdGF0aWMgZXhlQ01EKHdvcmtEaXI6IHN0cmluZywgY21kOiBzdHJpbmcsIG9uTXNnPzogKG1zZzogc3RyaW5nKSA9PiB2b2lkKSB7XG4gICAgICAgIGxldCBwID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgbGV0IHJlc3VsdCA9IGNoaWxkX3Byb2Nlc3MuZXhlYyhjbWQsIHsgY3dkOiB3b3JrRGlyIH0pO1xuICAgICAgICAgICAgcmVzdWx0LnN0ZG91dC5vbihcImRhdGFcIiwgKGRhdGEpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgZCA9IGRhdGEudG9TdHJpbmcoKTtcbiAgICAgICAgICAgICAgICBvbk1zZyAmJiBvbk1zZyhkKTtcbiAgICAgICAgICAgICAgICBpZiAoZC5pbmRleE9mKFwiY29udGludWVcIikgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQua2lsbCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmVzdWx0LnN0ZGVyci5vbihcImRhdGFcIiwgKGRhdGEpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZ2xvYmFsVGhpc1snRWRpdG9yJ10pIHtcbiAgICAgICAgICAgICAgICAgICAgTG9nZ2VyLmVycm9yKGRhdGEudG9TdHJpbmcoKSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgTG9nZ2VyLmVycm9yKGRhdGEudG9TdHJpbmcoKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXN1bHQub24oXCJjbG9zZVwiLCAoY29kZSkgPT4ge1xuICAgICAgICAgICAgICAgIHJlc29sdmUoY29kZSA/IGNvZGUgOiAwKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KVxuICAgICAgICByZXR1cm4gcDtcbiAgICB9XG5cbiAgICAvKiog6I635Y+W5oyH5a6a55uu5b2V5LiL5omA5pyJ5paH5Lu2ICovXG4gICAgcHVibGljIHN0YXRpYyBnZXRBbGxGaWxlcyhkaXI6IHN0cmluZywgZmlsdGVyPzogKGZpbGU6IHN0cmluZykgPT4gYm9vbGVhbiwgdG9wRGlyT25seSA9IGZhbHNlKSB7XG4gICAgICAgIGRpciA9IHRoaXMudG9BYnNvbHV0ZVBhdGgoZGlyKTtcbiAgICAgICAgbGV0IGZpbGVzOiBzdHJpbmdbXSA9IFtdO1xuICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMoZGlyKSkgcmV0dXJuIGZpbGVzO1xuICAgICAgICBsZXQgd2Fsa1N5bmMgPSAoY3VycmVudERpcjogc3RyaW5nLCBjYWxsYmFjazogKGZpbGVQYXRoOiBzdHJpbmcpID0+IHZvaWQpID0+IHtcbiAgICAgICAgICAgIGZzLnJlYWRkaXJTeW5jKGN1cnJlbnREaXIsIHsgd2l0aEZpbGVUeXBlczogdHJ1ZSB9KS5mb3JFYWNoKGRpcmVudCA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IHAgPSBwYXRoLmpvaW4oY3VycmVudERpciwgZGlyZW50Lm5hbWUpO1xuICAgICAgICAgICAgICAgIGlmIChkaXJlbnQuaXNGaWxlKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2socCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChkaXJlbnQuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAodG9wRGlyT25seSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB3YWxrU3luYyhwLCBjYWxsYmFjayk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcbiAgICAgICAgd2Fsa1N5bmMoZGlyLCBmaWxlID0+IHtcbiAgICAgICAgICAgIGlmIChmaWxlLmVuZHNXaXRoKFwiLm1ldGFcIikpIHJldHVybjtcbiAgICAgICAgICAgIGlmICghZmlsdGVyIHx8IGZpbHRlcihmaWxlKSkge1xuICAgICAgICAgICAgICAgIGZpbGVzLnB1c2godGhpcy50b1VuaVNlcGFyYXRvcihmaWxlKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gZmlsZXM7XG4gICAgfVxuXG4gICAgLyoqIOiOt+WPluaMh+WumuebruW9leS4i+aJgOacieebruW9lSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgZ2V0QWxsRGlycyhkaXI6IHN0cmluZywgZmlsdGVyPzogKGRpcjogc3RyaW5nKSA9PiBib29sZWFuLCB0b3BEaXJPbmx5ID0gZmFsc2UpIHtcbiAgICAgICAgZGlyID0gdGhpcy50b0Fic29sdXRlUGF0aChkaXIpO1xuICAgICAgICBsZXQgZGlyczogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKGRpcikpIHJldHVybiBkaXJzO1xuICAgICAgICBsZXQgd2Fsa1N5bmMgPSAoY3VycmVudERpcjogc3RyaW5nLCBjYWxsYmFjazogKGZpbGVQYXRoOiBzdHJpbmcpID0+IHZvaWQpID0+IHtcbiAgICAgICAgICAgIGZzLnJlYWRkaXJTeW5jKGN1cnJlbnREaXIsIHsgd2l0aEZpbGVUeXBlczogdHJ1ZSB9KS5mb3JFYWNoKGRpcmVudCA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IHAgPSBwYXRoLmpvaW4oY3VycmVudERpciwgZGlyZW50Lm5hbWUpO1xuICAgICAgICAgICAgICAgIGlmIChkaXJlbnQuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhwKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRvcERpck9ubHkpIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgd2Fsa1N5bmMocCwgY2FsbGJhY2spO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgICAgICB3YWxrU3luYyhkaXIsIHN1YkRpciA9PiB7XG4gICAgICAgICAgICBpZiAoIWZpbHRlciB8fCBmaWx0ZXIoc3ViRGlyKSkge1xuICAgICAgICAgICAgICAgIGRpcnMucHVzaCh0aGlzLnRvVW5pU2VwYXJhdG9yKHN1YkRpcikpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGRpcnM7XG4gICAgfVxuXG4gICAgLyoqIOagueaNruaWh+S7tui3r+W+hOaJvuWIsOi/veWKoOS6hk1kNeWAvOeahOWunumZheaWh+S7tui3r+W+hCAqL1xuICAgIHB1YmxpYyBzdGF0aWMgcmVzb2x2ZUZpbGVQYXRoKGZpbGVQYXRoOiBzdHJpbmcpIHtcbiAgICAgICAgbGV0IHJlc3VsdCA9IGZpbGVQYXRoO1xuICAgICAgICBsZXQgZGlyID0gcGF0aC5kaXJuYW1lKGZpbGVQYXRoKTtcbiAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMoZGlyKSkge1xuICAgICAgICAgICAgbGV0IGJhc2VuYW1lID0gcGF0aC5iYXNlbmFtZShmaWxlUGF0aCk7XG4gICAgICAgICAgICBsZXQgZXh0ID0gcGF0aC5leHRuYW1lKGZpbGVQYXRoKTtcbiAgICAgICAgICAgIGxldCBuYW1lID0gYmFzZW5hbWUucmVwbGFjZShleHQsIFwiLlwiKTtcbiAgICAgICAgICAgIGxldCByZWcgPSBuZXcgUmVnRXhwKGAke25hbWV9W0EtWmEtejAtOV17NX0ke2V4dH1gKTtcbiAgICAgICAgICAgIGxldCBkaXJlbnRzID0gZnMucmVhZGRpclN5bmMoZGlyLCB7IHdpdGhGaWxlVHlwZXM6IHRydWUgfSk7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGRpcmVudCBvZiBkaXJlbnRzKSB7XG4gICAgICAgICAgICAgICAgbGV0IHAgPSBwYXRoLmpvaW4oZGlyLCBkaXJlbnQubmFtZSk7XG4gICAgICAgICAgICAgICAgaWYgKGRpcmVudC5pc0ZpbGUoKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZGlyZW50Lm5hbWUgPT0gYmFzZW5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlZy50ZXN0KGRpcmVudC5uYW1lKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IHA7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMudG9VbmlTZXBhcmF0b3IocmVzdWx0KTtcbiAgICB9XG5cbiAgICAvKiog5bCG6L+95Yqg5LqGTWQ155qE5paH5Lu26Lev5b6E6L+Y5Y6f5Li65q2j5bi455qE5paH5Lu26Lev5b6EICovXG4gICAgcHVibGljIHN0YXRpYyByZXN0b3JlRmlsZVBhdGgoZmlsZVBhdGg6IHN0cmluZykge1xuICAgICAgICBsZXQgZXh0ID0gcGF0aC5leHRuYW1lKGZpbGVQYXRoKTtcbiAgICAgICAgbGV0IHAgPSBmaWxlUGF0aC5yZXBsYWNlKGV4dCwgXCJcIik7XG4gICAgICAgIGxldCByZWcgPSBuZXcgUmVnRXhwKC8uK1xcLltBLVphLXowLTldezV9Lyk7XG4gICAgICAgIGlmIChyZWcudGVzdChwKSkge1xuICAgICAgICAgICAgbGV0IGluZGV4ID0gcC5sYXN0SW5kZXhPZihcIi5cIilcbiAgICAgICAgICAgIHJldHVybiBwLnN1YnN0cmluZygwLCBpbmRleCkgKyBleHQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gZmlsZVBhdGg7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKiog5L+u5pS55paH5Lu25ZCN77yM5L2/5YW25paH5Lu25ZCN5ZCO6L+95YqgTWQ15YC8ICovXG4gICAgcHVibGljIHN0YXRpYyBhcHBlbmRNZDUoZmlsZVBhdGg6IHN0cmluZykge1xuICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhmaWxlUGF0aCkpIHtcbiAgICAgICAgICAgIGxldCBleHQgPSBwYXRoLmV4dG5hbWUoZmlsZVBhdGgpO1xuICAgICAgICAgICAgbGV0IHAgPSBmaWxlUGF0aC5yZXBsYWNlKGV4dCwgXCJcIik7XG4gICAgICAgICAgICBsZXQgcmVnID0gbmV3IFJlZ0V4cCgvLitcXC5bQS1aYS16MC05XXs1fS8pO1xuICAgICAgICAgICAgaWYgKCFyZWcudGVzdChwKSkge1xuICAgICAgICAgICAgICAgIGxldCBtZDUgPSBjcnlwdG8uY3JlYXRlSGFzaCgnbWQ1JykudXBkYXRlKGZzLnJlYWRGaWxlU3luYyhmaWxlUGF0aCkpLmRpZ2VzdCgnaGV4Jyk7XG4gICAgICAgICAgICAgICAgbGV0IHNob3J0TWQ1ID0gbWQ1LnN1YnN0cmluZygwLCA2KTtcbiAgICAgICAgICAgICAgICBsZXQgbmV3RmlsZVBhdGggPSBwICsgXCIuXCIgKyBzaG9ydE1kNSArIGV4dDtcbiAgICAgICAgICAgICAgICBmcy5yZW5hbWVTeW5jKGZpbGVQYXRoLCBuZXdGaWxlUGF0aCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKiog5L+u5pS55paH5Lu25ZCN77yM56e76Zmk5YW25paH5Lu25ZCN5ZCO55qETWQ15YC8ICovXG4gICAgcHVibGljIHN0YXRpYyByZW1vdmVNZDUoZmlsZVBhdGg6IHN0cmluZykge1xuICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhmaWxlUGF0aCkpIHtcbiAgICAgICAgICAgIGxldCBuZXdGaWxlUGF0aCA9IHRoaXMucmVzdG9yZUZpbGVQYXRoKGZpbGVQYXRoKTtcbiAgICAgICAgICAgIGZzLnJlbmFtZVN5bmMoZmlsZVBhdGgsIG5ld0ZpbGVQYXRoKTtcbiAgICAgICAgfVxuICAgIH1cblxuXG5cbiAgICAvKiog5Yi35paw57yW6L6R5Zmo5YaF55qE6LWE5rqQICovXG4gICAgcHVibGljIHN0YXRpYyByZWZyZXNoQXNzZXQocGF0aDogc3RyaW5nKSB7XG4gICAgICAgIGlmICghcGF0aC5zdGFydHNXaXRoKFwiZGI6XCIpICYmIGZzLnN0YXRTeW5jKHBhdGgpLmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgICAgICAgIGxldCBmaWxlcyA9IFV0aWxzLmdldEFsbEZpbGVzKHBhdGgsIG51bGwsIHRydWUpO1xuICAgICAgICAgICAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7XG4gICAgICAgICAgICAgICAgRWRpdG9yLk1lc3NhZ2Uuc2VuZChcImFzc2V0LWRiXCIsIFwicmVmcmVzaC1hc3NldFwiLCB0aGlzLnRvQXNzZXREQlVybChmaWxlKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBFZGl0b3IuTWVzc2FnZS5zZW5kKFwiYXNzZXQtZGJcIiwgXCJyZWZyZXNoLWFzc2V0XCIsIHRoaXMudG9Bc3NldERCVXJsKHBhdGgpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKiDliKDpmaTnvJbovpHlmajlhoXnmoTotYTmupAgKi9cbiAgICBwdWJsaWMgc3RhdGljIGRlbGV0ZUFzc2V0KHBhdGg6IHN0cmluZykge1xuICAgICAgICBFZGl0b3IuTWVzc2FnZS5zZW5kKFwiYXNzZXQtZGJcIiwgXCJkZWxldGUtYXNzZXRcIiwgdGhpcy50b0Fzc2V0REJVcmwocGF0aCkpO1xuICAgIH1cblxuICAgIC8qKiDlsIbmnKzlnLDmlofku7bot6/lvoTovazljJbkuLrnvJbovpHlmajlhoXotYTmupDot6/lvoQgKi9cbiAgICBwdWJsaWMgc3RhdGljIHRvQXNzZXREQlVybChwYXRoOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKHBhdGguc3RhcnRzV2l0aChcImRiOi8vXCIpKSByZXR1cm4gcGF0aDtcbiAgICAgICAgZWxzZSByZXR1cm4gcGF0aC5yZXBsYWNlKHRoaXMuUHJvamVjdFBhdGggKyBcIi9cIiwgXCJkYjovL1wiKTtcbiAgICB9XG5cbiAgICAvKiog5bCG57yW6L6R5Zmo5YaF6LWE5rqQ6Lev5b6E6L2s5YyW5Li65pys5Zyw5paH5Lu26Lev5b6EICovXG4gICAgcHVibGljIHN0YXRpYyB0b0Fic29sdXRlUGF0aChkYlVybE9ycHJvalVybDogc3RyaW5nKSB7XG4gICAgICAgIGlmIChkYlVybE9ycHJvalVybC5zdGFydHNXaXRoKFwiZGI6Ly9cIikpIHJldHVybiBkYlVybE9ycHJvalVybC5yZXBsYWNlKFwiZGI6Ly9cIiwgdGhpcy5Qcm9qZWN0UGF0aCArIFwiL1wiKTtcbiAgICAgICAgZWxzZSBpZiAoZGJVcmxPcnByb2pVcmwuc3RhcnRzV2l0aChcInByb2plY3Q6Ly9cIikpIHJldHVybiBkYlVybE9ycHJvalVybC5yZXBsYWNlKFwiZGI6Ly9cIiwgdGhpcy5Qcm9qZWN0UGF0aCArIFwiL1wiKTtcbiAgICAgICAgZWxzZSByZXR1cm4gZGJVcmxPcnByb2pVcmw7XG4gICAgfVxuXG4gICAgLyoqIOe7n+S4gOi3r+W+hOWIhumalOespuS4uigvKSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgdG9VbmlTZXBhcmF0b3IocGF0aDogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiBwYXRoLnJlcGxhY2UoL1xcXFwvZywgXCIvXCIpO1xuICAgIH1cblxuICAgIC8qKiDnu5/kuIDmjaLooYznrKbkuLooXFxuKSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgdG9VbmlMaW5lQnJha2UoY29udGVudDogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiBjb250ZW50LnJlcGxhY2UoL1xcXFxyXFxcXG4vZywgXCJcXG5cIik7XG4gICAgfVxuXG4gICAgLyoqIOiOt+WPluaWh+S7tuaIluiAheebruW9leaJgOWcqOeahGJ1bmRsZei3r+W+hCAqL1xuICAgIHB1YmxpYyBzdGF0aWMgZ2V0QnVuZGxlUGF0aChmaWxlUGF0aDogc3RyaW5nKSB7XG4gICAgICAgIGZpbGVQYXRoID0gdGhpcy50b1VuaVNlcGFyYXRvcihmaWxlUGF0aCk7XG4gICAgICAgIGxldCBkaXIgPSBwYXRoLmRpcm5hbWUoZmlsZVBhdGgpO1xuICAgICAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgICAgICAgbGV0IG1ldGEgPSBkaXIgKyBcIi5tZXRhXCI7XG4gICAgICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhtZXRhKSkge1xuICAgICAgICAgICAgICAgIGxldCBvYmogPSBmcy5yZWFkSnNvblN5bmMobWV0YSk7XG4gICAgICAgICAgICAgICAgaWYgKG9iaj8udXNlckRhdGE/LmlzQnVuZGxlKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBkaXI7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZGlyID0gcGF0aC5kaXJuYW1lKGRpcik7XG4gICAgICAgICAgICAgICAgICAgIGlmIChkaXIgPT0gdGhpcy5wcm9qZWN0UGF0aCkgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG59Il19