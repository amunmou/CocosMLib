"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Utils = void 0;
const child_process_1 = __importDefault(require("child_process"));
const crypto_1 = __importDefault(require("crypto"));
const fs_1 = __importDefault(require("fs"));
const path_1 = __importDefault(require("path"));
const Logger_1 = require("./Logger");
class Utils {
    static get ProjectPath() {
        if (!this.projectPath)
            this.projectPath = this.toUniSeparator(Editor.Project.path);
        return this.projectPath;
    }
    /** 是否原生平台 */
    static isNative(platform) {
        switch (platform) {
            case "windows":
            case "mac":
            case "linux":
            case "android":
            case "ios":
                return true;
        }
        return false;
    }
    /** 是否小游戏平台 */
    static isMinigame(platform) {
        switch (platform) {
            case "wechatgame":
            case "alipay-mini-game":
            case "bytedance-mini-game":
            case "baidu-mini-game":
            case "taobao-creative-app":
                return true;
        }
        return false;
    }
    /** 执行终端命令 */
    static exeCMD(workDir, cmd, onMsg) {
        let p = new Promise((resolve, reject) => {
            let result = child_process_1.default.exec(cmd, { cwd: workDir });
            result.stdout.on("data", (data) => {
                let d = data.toString();
                onMsg && onMsg(d);
                if (d.indexOf("continue") > -1) {
                    result.kill();
                }
            });
            result.stderr.on("data", (data) => {
                if (globalThis['Editor']) {
                    Logger_1.Logger.error(data.toString());
                }
                else {
                    Logger_1.Logger.error(data.toString());
                }
            });
            result.on("close", (code) => {
                resolve(code ? code : 0);
            });
        });
        return p;
    }
    /** 获取指定目录下所有文件 */
    static getAllFiles(dir, filter, topDirOnly = false) {
        dir = this.toAbsolutePath(dir);
        let files = [];
        if (!fs_1.default.existsSync(dir))
            return files;
        let walkSync = (currentDir, callback) => {
            fs_1.default.readdirSync(currentDir, { withFileTypes: true }).forEach(dirent => {
                let p = path_1.default.join(currentDir, dirent.name);
                if (dirent.isFile()) {
                    callback(p);
                }
                else if (dirent.isDirectory()) {
                    if (topDirOnly)
                        return;
                    walkSync(p, callback);
                }
            });
        };
        walkSync(dir, file => {
            if (file.endsWith(".meta"))
                return;
            if (!filter || filter(file)) {
                files.push(this.toUniSeparator(file));
            }
        });
        return files;
    }
    /** 获取指定目录下所有目录 */
    static getAllDirs(dir, filter, topDirOnly = false) {
        dir = this.toAbsolutePath(dir);
        let dirs = [];
        if (!fs_1.default.existsSync(dir))
            return dirs;
        let walkSync = (currentDir, callback) => {
            fs_1.default.readdirSync(currentDir, { withFileTypes: true }).forEach(dirent => {
                let p = path_1.default.join(currentDir, dirent.name);
                if (dirent.isDirectory()) {
                    callback(p);
                    if (topDirOnly)
                        return;
                    walkSync(p, callback);
                }
            });
        };
        walkSync(dir, subDir => {
            if (!filter || filter(subDir)) {
                dirs.push(this.toUniSeparator(subDir));
            }
        });
        return dirs;
    }
    /** 根据文件路径找到追加了Md5值的实际文件路径 */
    static resolveFilePath(filePath) {
        let result = filePath;
        let dir = path_1.default.dirname(filePath);
        if (fs_1.default.existsSync(dir)) {
            let basename = path_1.default.basename(filePath);
            let ext = path_1.default.extname(filePath);
            let name = basename.replace(ext, ".");
            let reg = new RegExp(`${name}[A-Za-z0-9]{5}${ext}`);
            let dirents = fs_1.default.readdirSync(dir, { withFileTypes: true });
            for (const dirent of dirents) {
                let p = path_1.default.join(dir, dirent.name);
                if (dirent.isFile()) {
                    if (dirent.name == basename) {
                        break;
                    }
                    else {
                        if (reg.test(dirent.name)) {
                            result = p;
                            break;
                        }
                    }
                }
            }
        }
        return this.toUniSeparator(result);
    }
    /** 将追加了Md5的文件路径还原为正常的文件路径 */
    static restoreFilePath(filePath) {
        let ext = path_1.default.extname(filePath);
        let p = filePath.replace(ext, "");
        let reg = new RegExp(/.+\.[A-Za-z0-9]{5}/);
        if (reg.test(p)) {
            let index = p.lastIndexOf(".");
            return p.substring(0, index) + ext;
        }
        else {
            return filePath;
        }
    }
    /** 修改文件名，使其文件名后追加Md5值 */
    static appendMd5(filePath) {
        if (fs_1.default.existsSync(filePath)) {
            let ext = path_1.default.extname(filePath);
            let p = filePath.replace(ext, "");
            let reg = new RegExp(/.+\.[A-Za-z0-9]{5}/);
            if (!reg.test(p)) {
                let md5 = crypto_1.default.createHash('md5').update(fs_1.default.readFileSync(filePath)).digest('hex');
                let shortMd5 = md5.substring(0, 6);
                let newFilePath = p + "." + shortMd5 + ext;
                fs_1.default.renameSync(filePath, newFilePath);
            }
        }
    }
    /** 修改文件名，移除其文件名后的Md5值 */
    static removeMd5(filePath) {
        if (fs_1.default.existsSync(filePath)) {
            let newFilePath = this.restoreFilePath(filePath);
            fs_1.default.renameSync(filePath, newFilePath);
        }
    }
    /** 刷新编辑器内的资源 */
    static refreshAsset(path) {
        if (!path.startsWith("db:") && fs_1.default.statSync(path).isDirectory()) {
            let files = Utils.getAllFiles(path, null, true);
            for (const file of files) {
                Editor.Message.send("asset-db", "refresh-asset", this.toAssetDBUrl(file));
            }
        }
        else {
            Editor.Message.send("asset-db", "refresh-asset", this.toAssetDBUrl(path));
        }
    }
    /** 删除编辑器内的资源 */
    static deleteAsset(path) {
        Editor.Message.send("asset-db", "delete-asset", this.toAssetDBUrl(path));
    }
    /** 将本地文件路径转化为编辑器内资源路径 */
    static toAssetDBUrl(path) {
        if (path.startsWith("db://"))
            return path;
        else
            return path.replace(this.ProjectPath + "/", "db://");
    }
    /** 将编辑器内资源路径转化为本地文件路径 */
    static toAbsolutePath(dbUrlOrprojUrl) {
        if (dbUrlOrprojUrl.startsWith("db://"))
            return dbUrlOrprojUrl.replace("db://", this.ProjectPath + "/");
        else if (dbUrlOrprojUrl.startsWith("project://"))
            return dbUrlOrprojUrl.replace("db://", this.ProjectPath + "/");
        else
            return dbUrlOrprojUrl;
    }
    /** 统一路径分隔符为(/) */
    static toUniSeparator(path) {
        return path.replace(/\\/g, "/");
    }
    /** 统一换行符为(\n) */
    static toUniLineBrake(content) {
        return content.replace(/\\r\\n/g, "\n");
    }
}
exports.Utils = Utils;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zb3VyY2UvdG9vbHMvVXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsa0VBQTBDO0FBQzFDLG9EQUE0QjtBQUM1Qiw0Q0FBb0I7QUFDcEIsZ0RBQXdCO0FBQ3hCLHFDQUFrQztBQUNsQyxNQUFhLEtBQUs7SUFHUCxNQUFNLEtBQUssV0FBVztRQUN6QixJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVc7WUFBRSxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNuRixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUM7SUFDNUIsQ0FBQztJQUVELGFBQWE7SUFDTixNQUFNLENBQUMsUUFBUSxDQUFDLFFBQWdCO1FBQ25DLFFBQVEsUUFBUSxFQUFFO1lBQ2QsS0FBSyxTQUFTLENBQUM7WUFDZixLQUFLLEtBQUssQ0FBQztZQUNYLEtBQUssT0FBTyxDQUFDO1lBQ2IsS0FBSyxTQUFTLENBQUM7WUFDZixLQUFLLEtBQUs7Z0JBQ04sT0FBTyxJQUFJLENBQUM7U0FDbkI7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDO0lBRUQsY0FBYztJQUNQLE1BQU0sQ0FBQyxVQUFVLENBQUMsUUFBZ0I7UUFDckMsUUFBUSxRQUFRLEVBQUU7WUFDZCxLQUFLLFlBQVksQ0FBQztZQUNsQixLQUFLLGtCQUFrQixDQUFDO1lBQ3hCLEtBQUsscUJBQXFCLENBQUM7WUFDM0IsS0FBSyxpQkFBaUIsQ0FBQztZQUN2QixLQUFLLHFCQUFxQjtnQkFDdEIsT0FBTyxJQUFJLENBQUM7U0FDbkI7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDO0lBRUQsYUFBYTtJQUNOLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBZSxFQUFFLEdBQVcsRUFBRSxLQUE2QjtRQUM1RSxJQUFJLENBQUMsR0FBRyxJQUFJ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VSxFQUFFLGNBQWMsRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDN0UsQ0FBQztJQUVELHlCQUF5QjtJQUNsQixNQUFNLENBQUMsWUFBWSxDQUFDLElBQVk7UUFDbkMsSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQztZQUFFLE9BQU8sSUFBSSxDQUFDOztZQUNyQyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFdBQVcsR0FBRyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDOUQsQ0FBQztJQUVELHlCQUF5QjtJQUNsQixNQUFNLENBQUMsY0FBYyxDQUFDLGNBQXNCO1FBQy9DLElBQUksY0FBYyxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUM7WUFBRSxPQUFPLGNBQWMsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxXQUFXLEdBQUcsR0FBRyxDQUFDLENBQUM7YUFDbEcsSUFBSSxjQUFjLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQztZQUFFLE9BQU8sY0FBYyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLFdBQVcsR0FBRyxHQUFHLENBQUMsQ0FBQzs7WUFDNUcsT0FBTyxjQUFjLENBQUM7SUFDL0IsQ0FBQztJQUVELGtCQUFrQjtJQUNYLE1BQU0sQ0FBQyxjQUFjLENBQUMsSUFBWTtRQUNyQyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3BDLENBQUM7SUFFRCxpQkFBaUI7SUFDVixNQUFNLENBQUMsY0FBYyxDQUFDLE9BQWU7UUFDeEMsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUM1QyxDQUFDO0NBQ0o7QUFwTkQsc0JBb05DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNoaWxkX3Byb2Nlc3MgZnJvbSBcImNoaWxkX3Byb2Nlc3NcIjtcbmltcG9ydCBjcnlwdG8gZnJvbSBcImNyeXB0b1wiO1xuaW1wb3J0IGZzIGZyb20gXCJmc1wiO1xuaW1wb3J0IHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCB7IExvZ2dlciB9IGZyb20gXCIuL0xvZ2dlclwiO1xuZXhwb3J0IGNsYXNzIFV0aWxzIHtcblxuICAgIHByaXZhdGUgc3RhdGljIHByb2plY3RQYXRoOiBzdHJpbmc7XG4gICAgcHVibGljIHN0YXRpYyBnZXQgUHJvamVjdFBhdGgoKSB7XG4gICAgICAgIGlmICghdGhpcy5wcm9qZWN0UGF0aCkgdGhpcy5wcm9qZWN0UGF0aCA9IHRoaXMudG9VbmlTZXBhcmF0b3IoRWRpdG9yLlByb2plY3QucGF0aCk7XG4gICAgICAgIHJldHVybiB0aGlzLnByb2plY3RQYXRoO1xuICAgIH1cblxuICAgIC8qKiDmmK/lkKbljp/nlJ/lubPlj7AgKi9cbiAgICBwdWJsaWMgc3RhdGljIGlzTmF0aXZlKHBsYXRmb3JtOiBzdHJpbmcpIHtcbiAgICAgICAgc3dpdGNoIChwbGF0Zm9ybSkge1xuICAgICAgICAgICAgY2FzZSBcIndpbmRvd3NcIjpcbiAgICAgICAgICAgIGNhc2UgXCJtYWNcIjpcbiAgICAgICAgICAgIGNhc2UgXCJsaW51eFwiOlxuICAgICAgICAgICAgY2FzZSBcImFuZHJvaWRcIjpcbiAgICAgICAgICAgIGNhc2UgXCJpb3NcIjpcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLyoqIOaYr+WQpuWwj+a4uOaIj+W5s+WPsCAqL1xuICAgIHB1YmxpYyBzdGF0aWMgaXNNaW5pZ2FtZShwbGF0Zm9ybTogc3RyaW5nKSB7XG4gICAgICAgIHN3aXRjaCAocGxhdGZvcm0pIHtcbiAgICAgICAgICAgIGNhc2UgXCJ3ZWNoYXRnYW1lXCI6XG4gICAgICAgICAgICBjYXNlIFwiYWxpcGF5LW1pbmktZ2FtZVwiOlxuICAgICAgICAgICAgY2FzZSBcImJ5dGVkYW5jZS1taW5pLWdhbWVcIjpcbiAgICAgICAgICAgIGNhc2UgXCJiYWlkdS1taW5pLWdhbWVcIjpcbiAgICAgICAgICAgIGNhc2UgXCJ0YW9iYW8tY3JlYXRpdmUtYXBwXCI6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8qKiDmiafooYznu4jnq6/lkb3ku6QgKi9cbiAgICBwdWJsaWMgc3RhdGljIGV4ZUNNRCh3b3JrRGlyOiBzdHJpbmcsIGNtZDogc3RyaW5nLCBvbk1zZz86IChtc2c6IHN0cmluZykgPT4gdm9pZCkge1xuICAgICAgICBsZXQgcCA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGxldCByZXN1bHQgPSBjaGlsZF9wcm9jZXNzLmV4ZWMoY21kLCB7IGN3ZDogd29ya0RpciB9KTtcbiAgICAgICAgICAgIHJlc3VsdC5zdGRvdXQub24oXCJkYXRhXCIsIChkYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGQgPSBkYXRhLnRvU3RyaW5nKCk7XG4gICAgICAgICAgICAgICAgb25Nc2cgJiYgb25Nc2coZCk7XG4gICAgICAgICAgICAgICAgaWYgKGQuaW5kZXhPZihcImNvbnRpbnVlXCIpID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LmtpbGwoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJlc3VsdC5zdGRlcnIub24oXCJkYXRhXCIsIChkYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGdsb2JhbFRoaXNbJ0VkaXRvciddKSB7XG4gICAgICAgICAgICAgICAgICAgIExvZ2dlci5lcnJvcihkYXRhLnRvU3RyaW5nKCkpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIExvZ2dlci5lcnJvcihkYXRhLnRvU3RyaW5nKCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmVzdWx0Lm9uKFwiY2xvc2VcIiwgKGNvZGUpID0+IHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKGNvZGUgPyBjb2RlIDogMCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSlcbiAgICAgICAgcmV0dXJuIHA7XG4gICAgfVxuXG4gICAgLyoqIOiOt+WPluaMh+WumuebruW9leS4i+aJgOacieaWh+S7tiAqL1xuICAgIHB1YmxpYyBzdGF0aWMgZ2V0QWxsRmlsZXMoZGlyOiBzdHJpbmcsIGZpbHRlcj86IChmaWxlOiBzdHJpbmcpID0+IGJvb2xlYW4sIHRvcERpck9ubHkgPSBmYWxzZSkge1xuICAgICAgICBkaXIgPSB0aGlzLnRvQWJzb2x1dGVQYXRoKGRpcik7XG4gICAgICAgIGxldCBmaWxlczogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKGRpcikpIHJldHVybiBmaWxlcztcbiAgICAgICAgbGV0IHdhbGtTeW5jID0gKGN1cnJlbnREaXI6IHN0cmluZywgY2FsbGJhY2s6IChmaWxlUGF0aDogc3RyaW5nKSA9PiB2b2lkKSA9PiB7XG4gICAgICAgICAgICBmcy5yZWFkZGlyU3luYyhjdXJyZW50RGlyLCB7IHdpdGhGaWxlVHlwZXM6IHRydWUgfSkuZm9yRWFjaChkaXJlbnQgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBwID0gcGF0aC5qb2luKGN1cnJlbnREaXIsIGRpcmVudC5uYW1lKTtcbiAgICAgICAgICAgICAgICBpZiAoZGlyZW50LmlzRmlsZSgpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHApO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGlyZW50LmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRvcERpck9ubHkpIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgd2Fsa1N5bmMocCwgY2FsbGJhY2spO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgICAgIHdhbGtTeW5jKGRpciwgZmlsZSA9PiB7XG4gICAgICAgICAgICBpZiAoZmlsZS5lbmRzV2l0aChcIi5tZXRhXCIpKSByZXR1cm47XG4gICAgICAgICAgICBpZiAoIWZpbHRlciB8fCBmaWx0ZXIoZmlsZSkpIHtcbiAgICAgICAgICAgICAgICBmaWxlcy5wdXNoKHRoaXMudG9VbmlTZXBhcmF0b3IoZmlsZSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGZpbGVzO1xuICAgIH1cblxuICAgIC8qKiDojrflj5bmjIflrprnm67lvZXkuIvmiYDmnInnm67lvZUgKi9cbiAgICBwdWJsaWMgc3RhdGljIGdldEFsbERpcnMoZGlyOiBzdHJpbmcsIGZpbHRlcj86IChkaXI6IHN0cmluZykgPT4gYm9vbGVhbiwgdG9wRGlyT25seSA9IGZhbHNlKSB7XG4gICAgICAgIGRpciA9IHRoaXMudG9BYnNvbHV0ZVBhdGgoZGlyKTtcbiAgICAgICAgbGV0IGRpcnM6IHN0cmluZ1tdID0gW107XG4gICAgICAgIGlmICghZnMuZXhpc3RzU3luYyhkaXIpKSByZXR1cm4gZGlycztcbiAgICAgICAgbGV0IHdhbGtTeW5jID0gKGN1cnJlbnREaXI6IHN0cmluZywgY2FsbGJhY2s6IChmaWxlUGF0aDogc3RyaW5nKSA9PiB2b2lkKSA9PiB7XG4gICAgICAgICAgICBmcy5yZWFkZGlyU3luYyhjdXJyZW50RGlyLCB7IHdpdGhGaWxlVHlwZXM6IHRydWUgfSkuZm9yRWFjaChkaXJlbnQgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBwID0gcGF0aC5qb2luKGN1cnJlbnREaXIsIGRpcmVudC5uYW1lKTtcbiAgICAgICAgICAgICAgICBpZiAoZGlyZW50LmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2socCk7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0b3BEaXJPbmx5KSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIHdhbGtTeW5jKHAsIGNhbGxiYWNrKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcbiAgICAgICAgd2Fsa1N5bmMoZGlyLCBzdWJEaXIgPT4ge1xuICAgICAgICAgICAgaWYgKCFmaWx0ZXIgfHwgZmlsdGVyKHN1YkRpcikpIHtcbiAgICAgICAgICAgICAgICBkaXJzLnB1c2godGhpcy50b1VuaVNlcGFyYXRvcihzdWJEaXIpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBkaXJzO1xuICAgIH1cblxuICAgIC8qKiDmoLnmja7mlofku7bot6/lvoTmib7liLDov73liqDkuoZNZDXlgLznmoTlrp7pmYXmlofku7bot6/lvoQgKi9cbiAgICBwdWJsaWMgc3RhdGljIHJlc29sdmVGaWxlUGF0aChmaWxlUGF0aDogc3RyaW5nKSB7XG4gICAgICAgIGxldCByZXN1bHQgPSBmaWxlUGF0aDtcbiAgICAgICAgbGV0IGRpciA9IHBhdGguZGlybmFtZShmaWxlUGF0aCk7XG4gICAgICAgIGlmIChmcy5leGlzdHNTeW5jKGRpcikpIHtcbiAgICAgICAgICAgIGxldCBiYXNlbmFtZSA9IHBhdGguYmFzZW5hbWUoZmlsZVBhdGgpO1xuICAgICAgICAgICAgbGV0IGV4dCA9IHBhdGguZXh0bmFtZShmaWxlUGF0aCk7XG4gICAgICAgICAgICBsZXQgbmFtZSA9IGJhc2VuYW1lLnJlcGxhY2UoZXh0LCBcIi5cIik7XG4gICAgICAgICAgICBsZXQgcmVnID0gbmV3IFJlZ0V4cChgJHtuYW1lfVtBLVphLXowLTldezV9JHtleHR9YCk7XG4gICAgICAgICAgICBsZXQgZGlyZW50cyA9IGZzLnJlYWRkaXJTeW5jKGRpciwgeyB3aXRoRmlsZVR5cGVzOiB0cnVlIH0pO1xuICAgICAgICAgICAgZm9yIChjb25zdCBkaXJlbnQgb2YgZGlyZW50cykge1xuICAgICAgICAgICAgICAgIGxldCBwID0gcGF0aC5qb2luKGRpciwgZGlyZW50Lm5hbWUpO1xuICAgICAgICAgICAgICAgIGlmIChkaXJlbnQuaXNGaWxlKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRpcmVudC5uYW1lID09IGJhc2VuYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZWcudGVzdChkaXJlbnQubmFtZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBwO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLnRvVW5pU2VwYXJhdG9yKHJlc3VsdCk7XG4gICAgfVxuXG4gICAgLyoqIOWwhui/veWKoOS6hk1kNeeahOaWh+S7tui3r+W+hOi/mOWOn+S4uuato+W4uOeahOaWh+S7tui3r+W+hCAqL1xuICAgIHB1YmxpYyBzdGF0aWMgcmVzdG9yZUZpbGVQYXRoKGZpbGVQYXRoOiBzdHJpbmcpIHtcbiAgICAgICAgbGV0IGV4dCA9IHBhdGguZXh0bmFtZShmaWxlUGF0aCk7XG4gICAgICAgIGxldCBwID0gZmlsZVBhdGgucmVwbGFjZShleHQsIFwiXCIpO1xuICAgICAgICBsZXQgcmVnID0gbmV3IFJlZ0V4cCgvLitcXC5bQS1aYS16MC05XXs1fS8pO1xuICAgICAgICBpZiAocmVnLnRlc3QocCkpIHtcbiAgICAgICAgICAgIGxldCBpbmRleCA9IHAubGFzdEluZGV4T2YoXCIuXCIpXG4gICAgICAgICAgICByZXR1cm4gcC5zdWJzdHJpbmcoMCwgaW5kZXgpICsgZXh0O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIGZpbGVQYXRoO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqIOS/ruaUueaWh+S7tuWQje+8jOS9v+WFtuaWh+S7tuWQjeWQjui/veWKoE1kNeWAvCAqL1xuICAgIHB1YmxpYyBzdGF0aWMgYXBwZW5kTWQ1KGZpbGVQYXRoOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMoZmlsZVBhdGgpKSB7XG4gICAgICAgICAgICBsZXQgZXh0ID0gcGF0aC5leHRuYW1lKGZpbGVQYXRoKTtcbiAgICAgICAgICAgIGxldCBwID0gZmlsZVBhdGgucmVwbGFjZShleHQsIFwiXCIpO1xuICAgICAgICAgICAgbGV0IHJlZyA9IG5ldyBSZWdFeHAoLy4rXFwuW0EtWmEtejAtOV17NX0vKTtcbiAgICAgICAgICAgIGlmICghcmVnLnRlc3QocCkpIHtcbiAgICAgICAgICAgICAgICBsZXQgbWQ1ID0gY3J5cHRvLmNyZWF0ZUhhc2goJ21kNScpLnVwZGF0ZShmcy5yZWFkRmlsZVN5bmMoZmlsZVBhdGgpKS5kaWdlc3QoJ2hleCcpO1xuICAgICAgICAgICAgICAgIGxldCBzaG9ydE1kNSA9IG1kNS5zdWJzdHJpbmcoMCwgNik7XG4gICAgICAgICAgICAgICAgbGV0IG5ld0ZpbGVQYXRoID0gcCArIFwiLlwiICsgc2hvcnRNZDUgKyBleHQ7XG4gICAgICAgICAgICAgICAgZnMucmVuYW1lU3luYyhmaWxlUGF0aCwgbmV3RmlsZVBhdGgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqIOS/ruaUueaWh+S7tuWQje+8jOenu+mZpOWFtuaWh+S7tuWQjeWQjueahE1kNeWAvCAqL1xuICAgIHB1YmxpYyBzdGF0aWMgcmVtb3ZlTWQ1KGZpbGVQYXRoOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMoZmlsZVBhdGgpKSB7XG4gICAgICAgICAgICBsZXQgbmV3RmlsZVBhdGggPSB0aGlzLnJlc3RvcmVGaWxlUGF0aChmaWxlUGF0aCk7XG4gICAgICAgICAgICBmcy5yZW5hbWVTeW5jKGZpbGVQYXRoLCBuZXdGaWxlUGF0aCk7XG4gICAgICAgIH1cbiAgICB9XG5cblxuXG4gICAgLyoqIOWIt+aWsOe8lui+keWZqOWGheeahOi1hOa6kCAqL1xuICAgIHB1YmxpYyBzdGF0aWMgcmVmcmVzaEFzc2V0KHBhdGg6IHN0cmluZykge1xuICAgICAgICBpZiAoIXBhdGguc3RhcnRzV2l0aChcImRiOlwiKSAmJiBmcy5zdGF0U3luYyhwYXRoKS5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgICAgICBsZXQgZmlsZXMgPSBVdGlscy5nZXRBbGxGaWxlcyhwYXRoLCBudWxsLCB0cnVlKTtcbiAgICAgICAgICAgIGZvciAoY29uc3QgZmlsZSBvZiBmaWxlcykge1xuICAgICAgICAgICAgICAgIEVkaXRvci5NZXNzYWdlLnNlbmQoXCJhc3NldC1kYlwiLCBcInJlZnJlc2gtYXNzZXRcIiwgdGhpcy50b0Fzc2V0REJVcmwoZmlsZSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgRWRpdG9yLk1lc3NhZ2Uuc2VuZChcImFzc2V0LWRiXCIsIFwicmVmcmVzaC1hc3NldFwiLCB0aGlzLnRvQXNzZXREQlVybChwYXRoKSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKiog5Yig6Zmk57yW6L6R5Zmo5YaF55qE6LWE5rqQICovXG4gICAgcHVibGljIHN0YXRpYyBkZWxldGVBc3NldChwYXRoOiBzdHJpbmcpIHtcbiAgICAgICAgRWRpdG9yLk1lc3NhZ2Uuc2VuZChcImFzc2V0LWRiXCIsIFwiZGVsZXRlLWFzc2V0XCIsIHRoaXMudG9Bc3NldERCVXJsKHBhdGgpKTtcbiAgICB9XG5cbiAgICAvKiog5bCG5pys5Zyw5paH5Lu26Lev5b6E6L2s5YyW5Li657yW6L6R5Zmo5YaF6LWE5rqQ6Lev5b6EICovXG4gICAgcHVibGljIHN0YXRpYyB0b0Fzc2V0REJVcmwocGF0aDogc3RyaW5nKSB7XG4gICAgICAgIGlmIChwYXRoLnN0YXJ0c1dpdGgoXCJkYjovL1wiKSkgcmV0dXJuIHBhdGg7XG4gICAgICAgIGVsc2UgcmV0dXJuIHBhdGgucmVwbGFjZSh0aGlzLlByb2plY3RQYXRoICsgXCIvXCIsIFwiZGI6Ly9cIik7XG4gICAgfVxuXG4gICAgLyoqIOWwhue8lui+keWZqOWGhei1hOa6kOi3r+W+hOi9rOWMluS4uuacrOWcsOaWh+S7tui3r+W+hCAqL1xuICAgIHB1YmxpYyBzdGF0aWMgdG9BYnNvbHV0ZVBhdGgoZGJVcmxPcnByb2pVcmw6IHN0cmluZykge1xuICAgICAgICBpZiAoZGJVcmxPcnByb2pVcmwuc3RhcnRzV2l0aChcImRiOi8vXCIpKSByZXR1cm4gZGJVcmxPcnByb2pVcmwucmVwbGFjZShcImRiOi8vXCIsIHRoaXMuUHJvamVjdFBhdGggKyBcIi9cIik7XG4gICAgICAgIGVsc2UgaWYgKGRiVXJsT3Jwcm9qVXJsLnN0YXJ0c1dpdGgoXCJwcm9qZWN0Oi8vXCIpKSByZXR1cm4gZGJVcmxPcnByb2pVcmwucmVwbGFjZShcImRiOi8vXCIsIHRoaXMuUHJvamVjdFBhdGggKyBcIi9cIik7XG4gICAgICAgIGVsc2UgcmV0dXJuIGRiVXJsT3Jwcm9qVXJsO1xuICAgIH1cblxuICAgIC8qKiDnu5/kuIDot6/lvoTliIbpmpTnrKbkuLooLykgKi9cbiAgICBwdWJsaWMgc3RhdGljIHRvVW5pU2VwYXJhdG9yKHBhdGg6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gcGF0aC5yZXBsYWNlKC9cXFxcL2csIFwiL1wiKTtcbiAgICB9XG5cbiAgICAvKiog57uf5LiA5o2i6KGM56ym5Li6KFxcbikgKi9cbiAgICBwdWJsaWMgc3RhdGljIHRvVW5pTGluZUJyYWtlKGNvbnRlbnQ6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gY29udGVudC5yZXBsYWNlKC9cXFxcclxcXFxuL2csIFwiXFxuXCIpO1xuICAgIH1cbn0iXX0=