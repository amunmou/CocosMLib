"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Utils = void 0;
const child_process_1 = __importDefault(require("child_process"));
const crypto_1 = __importDefault(require("crypto"));
const fs_1 = __importDefault(require("fs"));
const path_1 = __importDefault(require("path"));
const Logger_1 = require("./Logger");
class Utils {
    static get ProjectPath() {
        if (!this.projectPath)
            this.projectPath = this.toUniSeparator(Editor.Project.path);
        return this.projectPath;
    }
    /** 是否原生平台 */
    static isNative(platform) {
        switch (platform) {
            case "windows":
            case "mac":
            case "linux":
            case "android":
            case "ios":
                return true;
        }
        return false;
    }
    /** 是否小游戏平台 */
    static isMinigame(platform) {
        switch (platform) {
            case "wechatgame":
            case "alipay-mini-game":
            case "bytedance-mini-game":
            case "baidu-mini-game":
            case "taobao-creative-app":
                return true;
        }
        return false;
    }
    /** 执行终端命令 */
    static exeCMD(workDir, cmd, onMsg) {
        let p = new Promise((resolve, reject) => {
            let result = child_process_1.default.exec(cmd, { cwd: workDir });
            result.stdout.on("data", (data) => {
                let d = data.toString();
                onMsg && onMsg(d);
                if (d.indexOf("continue") > -1) {
                    result.kill();
                }
            });
            result.stderr.on("data", (data) => {
                if (globalThis['Editor']) {
                    Logger_1.Logger.error(data.toString());
                }
                else {
                    Logger_1.Logger.error(data.toString());
                }
            });
            result.on("close", (code) => {
                resolve(code ? code : 0);
            });
        });
        return p;
    }
    /** 获取指定目录下所有文件 */
    static getAllFiles(dir, filter, topDirOnly = false) {
        dir = this.toAbsolutePath(dir);
        let files = [];
        if (!fs_1.default.existsSync(dir))
            return files;
        let walkSync = (currentDir, callback) => {
            fs_1.default.readdirSync(currentDir, { withFileTypes: true }).forEach(dirent => {
                let p = path_1.default.join(currentDir, dirent.name);
                if (dirent.isFile()) {
                    callback(p);
                }
                else if (dirent.isDirectory()) {
                    if (topDirOnly)
                        return;
                    walkSync(p, callback);
                }
            });
        };
        walkSync(dir, file => {
            if (file.endsWith(".meta"))
                return;
            if (!filter || filter(file)) {
                files.push(this.toUniSeparator(file));
            }
        });
        return files;
    }
    /** 获取指定目录下所有目录 */
    static getAllDirs(dir, filter, topDirOnly = false) {
        dir = this.toAbsolutePath(dir);
        let dirs = [];
        if (!fs_1.default.existsSync(dir))
            return dirs;
        let walkSync = (currentDir, callback) => {
            fs_1.default.readdirSync(currentDir, { withFileTypes: true }).forEach(dirent => {
                let p = path_1.default.join(currentDir, dirent.name);
                if (dirent.isDirectory()) {
                    callback(p);
                    if (topDirOnly)
                        return;
                    walkSync(p, callback);
                }
            });
        };
        walkSync(dir, subDir => {
            if (!filter || filter(subDir)) {
                dirs.push(this.toUniSeparator(subDir));
            }
        });
        return dirs;
    }
    /** 根据文件路径找到追加了Md5值的实际文件路径 */
    static resolveFilePath(filePath) {
        let result = filePath;
        let dir = path_1.default.dirname(filePath);
        if (fs_1.default.existsSync(dir)) {
            let basename = path_1.default.basename(filePath);
            let ext = path_1.default.extname(filePath);
            let name = basename.replace(ext, ".");
            let reg = new RegExp(`${name}[A-Za-z0-9]{5}${ext}`);
            let dirents = fs_1.default.readdirSync(dir, { withFileTypes: true });
            for (const dirent of dirents) {
                let p = path_1.default.join(dir, dirent.name);
                if (dirent.isFile()) {
                    if (dirent.name == basename) {
                        break;
                    }
                    else {
                        if (reg.test(dirent.name)) {
                            result = p;
                            break;
                        }
                    }
                }
            }
        }
        return result.replace(/\\/g, "/");
    }
    /** 将追加了Md5的文件路径还原为正常的文件路径 */
    static restoreFilePath(filePath) {
        let ext = path_1.default.extname(filePath);
        let p = filePath.replace(ext, "");
        let reg = new RegExp(/.+\.[A-Za-z0-9]{5}/);
        if (reg.test(p)) {
            let index = p.lastIndexOf(".");
            return p.substring(0, index) + ext;
        }
        else {
            return filePath;
        }
    }
    /** 修改文件名，使其文件名后追加Md5值 */
    static appendMd5(filePath) {
        if (fs_1.default.existsSync(filePath)) {
            let ext = path_1.default.extname(filePath);
            let p = filePath.replace(ext, "");
            let reg = new RegExp(/.+\.[A-Za-z0-9]{5}/);
            if (!reg.test(p)) {
                let md5 = crypto_1.default.createHash('md5').update(fs_1.default.readFileSync(filePath)).digest('hex');
                let shortMd5 = md5.substring(0, 6);
                let newFilePath = p + "." + shortMd5 + ext;
                fs_1.default.renameSync(filePath, newFilePath);
            }
        }
    }
    /** 修改文件名，移除其文件名后的Md5值 */
    static removeMd5(filePath) {
        if (fs_1.default.existsSync(filePath)) {
            let newFilePath = this.restoreFilePath(filePath);
            fs_1.default.renameSync(filePath, newFilePath);
        }
    }
    /** 刷新编辑器内的资源 */
    static refreshAsset(path) {
        if (!path.startsWith("db:") && fs_1.default.statSync(path).isDirectory()) {
            let files = Utils.getAllFiles(path, null, true);
            for (const file of files) {
                Editor.Message.send("asset-db", "refresh-asset", this.toAssetDBUrl(file));
            }
        }
        else {
            Editor.Message.send("asset-db", "refresh-asset", this.toAssetDBUrl(path));
        }
    }
    /** 删除编辑器内的资源 */
    static deleteAsset(path) {
        Editor.Message.send("asset-db", "delete-asset", this.toAssetDBUrl(path));
    }
    /** 将本地文件路径转化为编辑器内资源路径 */
    static toAssetDBUrl(path) {
        if (path.startsWith("db://"))
            return path;
        else
            return path.replace(this.ProjectPath + "/", "db://");
    }
    /** 将编辑器内资源路径转化为本地文件路径 */
    static toAbsolutePath(dbUrlOrprojUrl) {
        if (dbUrlOrprojUrl.startsWith("db://"))
            return dbUrlOrprojUrl.replace("db://", this.ProjectPath + "/");
        else if (dbUrlOrprojUrl.startsWith("project://"))
            return dbUrlOrprojUrl.replace("db://", this.ProjectPath + "/");
        else
            return dbUrlOrprojUrl;
    }
    /** 统一路径分隔符为(/) */
    static toUniSeparator(path) {
        return path.replace(/\\/g, "/");
    }
    /** 统一换行符为(\n) */
    static toUniLineBrake(content) {
        return content.replace(/\\r\\n/g, "\n");
    }
}
exports.Utils = Utils;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zb3VyY2UvdG9vbHMvVXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsa0VBQTBDO0FBQzFDLG9EQUE0QjtBQUM1Qiw0Q0FBb0I7QUFDcEIsZ0RBQXdCO0FBQ3hCLHFDQUFrQztBQUNsQyxNQUFhLEtBQUs7SUFHUCxNQUFNLEtBQUssV0FBVztRQUN6QixJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVc7WUFBRSxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNuRixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUM7SUFDNUIsQ0FBQztJQUVELGFBQWE7SUFDTixNQUFNLENBQUMsUUFBUSxDQUFDLFFBQWdCO1FBQ25DLFFBQVEsUUFBUSxFQUFFO1lBQ2QsS0FBSyxTQUFTLENBQUM7WUFDZixLQUFLLEtBQUssQ0FBQztZQUNYLEtBQUssT0FBTyxDQUFDO1lBQ2IsS0FBSyxTQUFTLENBQUM7WUFDZixLQUFLLEtBQUs7Z0JBQ04sT0FBTyxJQUFJLENBQUM7U0FDbkI7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDO0lBRUQsY0FBYztJQUNQLE1BQU0sQ0FBQyxVQUFVLENBQUMsUUFBZ0I7UUFDckMsUUFBUSxRQUFRLEVBQUU7WUFDZCxLQUFLLFlBQVksQ0FBQztZQUNsQixLQUFLLGtCQUFrQixDQUFDO1lBQ3hCLEtBQUsscUJBQXFCLENBQUM7WUFDM0IsS0FBSyxpQkFBaUIsQ0FBQztZQUN2QixLQUFLLHFCQUFxQjtnQkFDdEIsT0FBTyxJQUFJLENBQUM7U0FDbkI7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDO0lBRUQsYUFBYTtJQUNOLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBZSxFQUFFLEdBQVcsRUFBRSxLQUE2QjtRQUM1RSxJQUFJLENBQUMsR0FBRyxJQUFJ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SSxDQUFDLFVBQVUsRUFBRSxjQUFjLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQzdFLENBQUM7SUFFRCx5QkFBeUI7SUFDbEIsTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFZO1FBQ25DLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUM7WUFBRSxPQUFPLElBQUksQ0FBQzs7WUFDckMsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxXQUFXLEdBQUcsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQzlELENBQUM7SUFFRCx5QkFBeUI7SUFDbEIsTUFBTSxDQUFDLGNBQWMsQ0FBQyxjQUFzQjtRQUMvQyxJQUFJLGNBQWMsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDO1lBQUUsT0FBTyxjQUFjLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsV0FBVyxHQUFHLEdBQUcsQ0FBQyxDQUFDO2FBQ2xHLElBQUksY0FBYyxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUM7WUFBRSxPQUFPLGNBQWMsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxXQUFXLEdBQUcsR0FBRyxDQUFDLENBQUM7O1lBQzVHLE9BQU8sY0FBYyxDQUFDO0lBQy9CLENBQUM7SUFFRCxrQkFBa0I7SUFDWCxNQUFNLENBQUMsY0FBYyxDQUFDLElBQVk7UUFDckMsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBRUQsaUJBQWlCO0lBQ1YsTUFBTSxDQUFDLGNBQWMsQ0FBQyxPQUFlO1FBQ3hDLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDNUMsQ0FBQztDQUNKO0FBcE5ELHNCQW9OQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjaGlsZF9wcm9jZXNzIGZyb20gXCJjaGlsZF9wcm9jZXNzXCI7XG5pbXBvcnQgY3J5cHRvIGZyb20gXCJjcnlwdG9cIjtcbmltcG9ydCBmcyBmcm9tIFwiZnNcIjtcbmltcG9ydCBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgeyBMb2dnZXIgfSBmcm9tIFwiLi9Mb2dnZXJcIjtcbmV4cG9ydCBjbGFzcyBVdGlscyB7XG5cbiAgICBwcml2YXRlIHN0YXRpYyBwcm9qZWN0UGF0aDogc3RyaW5nO1xuICAgIHB1YmxpYyBzdGF0aWMgZ2V0IFByb2plY3RQYXRoKCkge1xuICAgICAgICBpZiAoIXRoaXMucHJvamVjdFBhdGgpIHRoaXMucHJvamVjdFBhdGggPSB0aGlzLnRvVW5pU2VwYXJhdG9yKEVkaXRvci5Qcm9qZWN0LnBhdGgpO1xuICAgICAgICByZXR1cm4gdGhpcy5wcm9qZWN0UGF0aDtcbiAgICB9XG5cbiAgICAvKiog5piv5ZCm5Y6f55Sf5bmz5Y+wICovXG4gICAgcHVibGljIHN0YXRpYyBpc05hdGl2ZShwbGF0Zm9ybTogc3RyaW5nKSB7XG4gICAgICAgIHN3aXRjaCAocGxhdGZvcm0pIHtcbiAgICAgICAgICAgIGNhc2UgXCJ3aW5kb3dzXCI6XG4gICAgICAgICAgICBjYXNlIFwibWFjXCI6XG4gICAgICAgICAgICBjYXNlIFwibGludXhcIjpcbiAgICAgICAgICAgIGNhc2UgXCJhbmRyb2lkXCI6XG4gICAgICAgICAgICBjYXNlIFwiaW9zXCI6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8qKiDmmK/lkKblsI/muLjmiI/lubPlj7AgKi9cbiAgICBwdWJsaWMgc3RhdGljIGlzTWluaWdhbWUocGxhdGZvcm06IHN0cmluZykge1xuICAgICAgICBzd2l0Y2ggKHBsYXRmb3JtKSB7XG4gICAgICAgICAgICBjYXNlIFwid2VjaGF0Z2FtZVwiOlxuICAgICAgICAgICAgY2FzZSBcImFsaXBheS1taW5pLWdhbWVcIjpcbiAgICAgICAgICAgIGNhc2UgXCJieXRlZGFuY2UtbWluaS1nYW1lXCI6XG4gICAgICAgICAgICBjYXNlIFwiYmFpZHUtbWluaS1nYW1lXCI6XG4gICAgICAgICAgICBjYXNlIFwidGFvYmFvLWNyZWF0aXZlLWFwcFwiOlxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvKiog5omn6KGM57uI56uv5ZG95LukICovXG4gICAgcHVibGljIHN0YXRpYyBleGVDTUQod29ya0Rpcjogc3RyaW5nLCBjbWQ6IHN0cmluZywgb25Nc2c/OiAobXNnOiBzdHJpbmcpID0+IHZvaWQpIHtcbiAgICAgICAgbGV0IHAgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBsZXQgcmVzdWx0ID0gY2hpbGRfcHJvY2Vzcy5leGVjKGNtZCwgeyBjd2Q6IHdvcmtEaXIgfSk7XG4gICAgICAgICAgICByZXN1bHQuc3Rkb3V0Lm9uKFwiZGF0YVwiLCAoZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBkID0gZGF0YS50b1N0cmluZygpO1xuICAgICAgICAgICAgICAgIG9uTXNnICYmIG9uTXNnKGQpO1xuICAgICAgICAgICAgICAgIGlmIChkLmluZGV4T2YoXCJjb250aW51ZVwiKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdC5raWxsKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXN1bHQuc3RkZXJyLm9uKFwiZGF0YVwiLCAoZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChnbG9iYWxUaGlzWydFZGl0b3InXSkge1xuICAgICAgICAgICAgICAgICAgICBMb2dnZXIuZXJyb3IoZGF0YS50b1N0cmluZygpKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBMb2dnZXIuZXJyb3IoZGF0YS50b1N0cmluZygpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJlc3VsdC5vbihcImNsb3NlXCIsIChjb2RlKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZShjb2RlID8gY29kZSA6IDApO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pXG4gICAgICAgIHJldHVybiBwO1xuICAgIH1cblxuICAgIC8qKiDojrflj5bmjIflrprnm67lvZXkuIvmiYDmnInmlofku7YgKi9cbiAgICBwdWJsaWMgc3RhdGljIGdldEFsbEZpbGVzKGRpcjogc3RyaW5nLCBmaWx0ZXI/OiAoZmlsZTogc3RyaW5nKSA9PiBib29sZWFuLCB0b3BEaXJPbmx5ID0gZmFsc2UpIHtcbiAgICAgICAgZGlyID0gdGhpcy50b0Fic29sdXRlUGF0aChkaXIpO1xuICAgICAgICBsZXQgZmlsZXM6IHN0cmluZ1tdID0gW107XG4gICAgICAgIGlmICghZnMuZXhpc3RzU3luYyhkaXIpKSByZXR1cm4gZmlsZXM7XG4gICAgICAgIGxldCB3YWxrU3luYyA9IChjdXJyZW50RGlyOiBzdHJpbmcsIGNhbGxiYWNrOiAoZmlsZVBhdGg6IHN0cmluZykgPT4gdm9pZCkgPT4ge1xuICAgICAgICAgICAgZnMucmVhZGRpclN5bmMoY3VycmVudERpciwgeyB3aXRoRmlsZVR5cGVzOiB0cnVlIH0pLmZvckVhY2goZGlyZW50ID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgcCA9IHBhdGguam9pbihjdXJyZW50RGlyLCBkaXJlbnQubmFtZSk7XG4gICAgICAgICAgICAgICAgaWYgKGRpcmVudC5pc0ZpbGUoKSkge1xuICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhwKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRpcmVudC5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0b3BEaXJPbmx5KSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIHdhbGtTeW5jKHAsIGNhbGxiYWNrKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgICAgICB3YWxrU3luYyhkaXIsIGZpbGUgPT4ge1xuICAgICAgICAgICAgaWYgKGZpbGUuZW5kc1dpdGgoXCIubWV0YVwiKSkgcmV0dXJuO1xuICAgICAgICAgICAgaWYgKCFmaWx0ZXIgfHwgZmlsdGVyKGZpbGUpKSB7XG4gICAgICAgICAgICAgICAgZmlsZXMucHVzaCh0aGlzLnRvVW5pU2VwYXJhdG9yKGZpbGUpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBmaWxlcztcbiAgICB9XG5cbiAgICAvKiog6I635Y+W5oyH5a6a55uu5b2V5LiL5omA5pyJ55uu5b2VICovXG4gICAgcHVibGljIHN0YXRpYyBnZXRBbGxEaXJzKGRpcjogc3RyaW5nLCBmaWx0ZXI/OiAoZGlyOiBzdHJpbmcpID0+IGJvb2xlYW4sIHRvcERpck9ubHkgPSBmYWxzZSkge1xuICAgICAgICBkaXIgPSB0aGlzLnRvQWJzb2x1dGVQYXRoKGRpcik7XG4gICAgICAgIGxldCBkaXJzOiBzdHJpbmdbXSA9IFtdO1xuICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMoZGlyKSkgcmV0dXJuIGRpcnM7XG4gICAgICAgIGxldCB3YWxrU3luYyA9IChjdXJyZW50RGlyOiBzdHJpbmcsIGNhbGxiYWNrOiAoZmlsZVBhdGg6IHN0cmluZykgPT4gdm9pZCkgPT4ge1xuICAgICAgICAgICAgZnMucmVhZGRpclN5bmMoY3VycmVudERpciwgeyB3aXRoRmlsZVR5cGVzOiB0cnVlIH0pLmZvckVhY2goZGlyZW50ID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgcCA9IHBhdGguam9pbihjdXJyZW50RGlyLCBkaXJlbnQubmFtZSk7XG4gICAgICAgICAgICAgICAgaWYgKGRpcmVudC5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHApO1xuICAgICAgICAgICAgICAgICAgICBpZiAodG9wRGlyT25seSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB3YWxrU3luYyhwLCBjYWxsYmFjayk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgICAgIHdhbGtTeW5jKGRpciwgc3ViRGlyID0+IHtcbiAgICAgICAgICAgIGlmICghZmlsdGVyIHx8IGZpbHRlcihzdWJEaXIpKSB7XG4gICAgICAgICAgICAgICAgZGlycy5wdXNoKHRoaXMudG9VbmlTZXBhcmF0b3Ioc3ViRGlyKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gZGlycztcbiAgICB9XG5cbiAgICAvKiog5qC55o2u5paH5Lu26Lev5b6E5om+5Yiw6L+95Yqg5LqGTWQ15YC855qE5a6e6ZmF5paH5Lu26Lev5b6EICovXG4gICAgcHVibGljIHN0YXRpYyByZXNvbHZlRmlsZVBhdGgoZmlsZVBhdGg6IHN0cmluZykge1xuICAgICAgICBsZXQgcmVzdWx0ID0gZmlsZVBhdGg7XG4gICAgICAgIGxldCBkaXIgPSBwYXRoLmRpcm5hbWUoZmlsZVBhdGgpO1xuICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhkaXIpKSB7XG4gICAgICAgICAgICBsZXQgYmFzZW5hbWUgPSBwYXRoLmJhc2VuYW1lKGZpbGVQYXRoKTtcbiAgICAgICAgICAgIGxldCBleHQgPSBwYXRoLmV4dG5hbWUoZmlsZVBhdGgpO1xuICAgICAgICAgICAgbGV0IG5hbWUgPSBiYXNlbmFtZS5yZXBsYWNlKGV4dCwgXCIuXCIpO1xuICAgICAgICAgICAgbGV0IHJlZyA9IG5ldyBSZWdFeHAoYCR7bmFtZX1bQS1aYS16MC05XXs1fSR7ZXh0fWApO1xuICAgICAgICAgICAgbGV0IGRpcmVudHMgPSBmcy5yZWFkZGlyU3luYyhkaXIsIHsgd2l0aEZpbGVUeXBlczogdHJ1ZSB9KTtcbiAgICAgICAgICAgIGZvciAoY29uc3QgZGlyZW50IG9mIGRpcmVudHMpIHtcbiAgICAgICAgICAgICAgICBsZXQgcCA9IHBhdGguam9pbihkaXIsIGRpcmVudC5uYW1lKTtcbiAgICAgICAgICAgICAgICBpZiAoZGlyZW50LmlzRmlsZSgpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChkaXJlbnQubmFtZSA9PSBiYXNlbmFtZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVnLnRlc3QoZGlyZW50Lm5hbWUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gcDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0LnJlcGxhY2UoL1xcXFwvZywgXCIvXCIpO1xuICAgIH1cblxuICAgIC8qKiDlsIbov73liqDkuoZNZDXnmoTmlofku7bot6/lvoTov5jljp/kuLrmraPluLjnmoTmlofku7bot6/lvoQgKi9cbiAgICBwdWJsaWMgc3RhdGljIHJlc3RvcmVGaWxlUGF0aChmaWxlUGF0aDogc3RyaW5nKSB7XG4gICAgICAgIGxldCBleHQgPSBwYXRoLmV4dG5hbWUoZmlsZVBhdGgpO1xuICAgICAgICBsZXQgcCA9IGZpbGVQYXRoLnJlcGxhY2UoZXh0LCBcIlwiKTtcbiAgICAgICAgbGV0IHJlZyA9IG5ldyBSZWdFeHAoLy4rXFwuW0EtWmEtejAtOV17NX0vKTtcbiAgICAgICAgaWYgKHJlZy50ZXN0KHApKSB7XG4gICAgICAgICAgICBsZXQgaW5kZXggPSBwLmxhc3RJbmRleE9mKFwiLlwiKVxuICAgICAgICAgICAgcmV0dXJuIHAuc3Vic3RyaW5nKDAsIGluZGV4KSArIGV4dDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBmaWxlUGF0aDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKiDkv67mlLnmlofku7blkI3vvIzkvb/lhbbmlofku7blkI3lkI7ov73liqBNZDXlgLwgKi9cbiAgICBwdWJsaWMgc3RhdGljIGFwcGVuZE1kNShmaWxlUGF0aDogc3RyaW5nKSB7XG4gICAgICAgIGlmIChmcy5leGlzdHNTeW5jKGZpbGVQYXRoKSkge1xuICAgICAgICAgICAgbGV0IGV4dCA9IHBhdGguZXh0bmFtZShmaWxlUGF0aCk7XG4gICAgICAgICAgICBsZXQgcCA9IGZpbGVQYXRoLnJlcGxhY2UoZXh0LCBcIlwiKTtcbiAgICAgICAgICAgIGxldCByZWcgPSBuZXcgUmVnRXhwKC8uK1xcLltBLVphLXowLTldezV9Lyk7XG4gICAgICAgICAgICBpZiAoIXJlZy50ZXN0KHApKSB7XG4gICAgICAgICAgICAgICAgbGV0IG1kNSA9IGNyeXB0by5jcmVhdGVIYXNoKCdtZDUnKS51cGRhdGUoZnMucmVhZEZpbGVTeW5jKGZpbGVQYXRoKSkuZGlnZXN0KCdoZXgnKTtcbiAgICAgICAgICAgICAgICBsZXQgc2hvcnRNZDUgPSBtZDUuc3Vic3RyaW5nKDAsIDYpO1xuICAgICAgICAgICAgICAgIGxldCBuZXdGaWxlUGF0aCA9IHAgKyBcIi5cIiArIHNob3J0TWQ1ICsgZXh0O1xuICAgICAgICAgICAgICAgIGZzLnJlbmFtZVN5bmMoZmlsZVBhdGgsIG5ld0ZpbGVQYXRoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKiDkv67mlLnmlofku7blkI3vvIznp7vpmaTlhbbmlofku7blkI3lkI7nmoRNZDXlgLwgKi9cbiAgICBwdWJsaWMgc3RhdGljIHJlbW92ZU1kNShmaWxlUGF0aDogc3RyaW5nKSB7XG4gICAgICAgIGlmIChmcy5leGlzdHNTeW5jKGZpbGVQYXRoKSkge1xuICAgICAgICAgICAgbGV0IG5ld0ZpbGVQYXRoID0gdGhpcy5yZXN0b3JlRmlsZVBhdGgoZmlsZVBhdGgpO1xuICAgICAgICAgICAgZnMucmVuYW1lU3luYyhmaWxlUGF0aCwgbmV3RmlsZVBhdGgpO1xuICAgICAgICB9XG4gICAgfVxuXG5cblxuICAgIC8qKiDliLfmlrDnvJbovpHlmajlhoXnmoTotYTmupAgKi9cbiAgICBwdWJsaWMgc3RhdGljIHJlZnJlc2hBc3NldChwYXRoOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKCFwYXRoLnN0YXJ0c1dpdGgoXCJkYjpcIikgJiYgZnMuc3RhdFN5bmMocGF0aCkuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgICAgICAgbGV0IGZpbGVzID0gVXRpbHMuZ2V0QWxsRmlsZXMocGF0aCwgbnVsbCwgdHJ1ZSk7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGZpbGUgb2YgZmlsZXMpIHtcbiAgICAgICAgICAgICAgICBFZGl0b3IuTWVzc2FnZS5zZW5kKFwiYXNzZXQtZGJcIiwgXCJyZWZyZXNoLWFzc2V0XCIsIHRoaXMudG9Bc3NldERCVXJsKGZpbGUpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIEVkaXRvci5NZXNzYWdlLnNlbmQoXCJhc3NldC1kYlwiLCBcInJlZnJlc2gtYXNzZXRcIiwgdGhpcy50b0Fzc2V0REJVcmwocGF0aCkpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqIOWIoOmZpOe8lui+keWZqOWGheeahOi1hOa6kCAqL1xuICAgIHB1YmxpYyBzdGF0aWMgZGVsZXRlQXNzZXQocGF0aDogc3RyaW5nKSB7XG4gICAgICAgIEVkaXRvci5NZXNzYWdlLnNlbmQoXCJhc3NldC1kYlwiLCBcImRlbGV0ZS1hc3NldFwiLCB0aGlzLnRvQXNzZXREQlVybChwYXRoKSk7XG4gICAgfVxuXG4gICAgLyoqIOWwhuacrOWcsOaWh+S7tui3r+W+hOi9rOWMluS4uue8lui+keWZqOWGhei1hOa6kOi3r+W+hCAqL1xuICAgIHB1YmxpYyBzdGF0aWMgdG9Bc3NldERCVXJsKHBhdGg6IHN0cmluZykge1xuICAgICAgICBpZiAocGF0aC5zdGFydHNXaXRoKFwiZGI6Ly9cIikpIHJldHVybiBwYXRoO1xuICAgICAgICBlbHNlIHJldHVybiBwYXRoLnJlcGxhY2UodGhpcy5Qcm9qZWN0UGF0aCArIFwiL1wiLCBcImRiOi8vXCIpO1xuICAgIH1cblxuICAgIC8qKiDlsIbnvJbovpHlmajlhoXotYTmupDot6/lvoTovazljJbkuLrmnKzlnLDmlofku7bot6/lvoQgKi9cbiAgICBwdWJsaWMgc3RhdGljIHRvQWJzb2x1dGVQYXRoKGRiVXJsT3Jwcm9qVXJsOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKGRiVXJsT3Jwcm9qVXJsLnN0YXJ0c1dpdGgoXCJkYjovL1wiKSkgcmV0dXJuIGRiVXJsT3Jwcm9qVXJsLnJlcGxhY2UoXCJkYjovL1wiLCB0aGlzLlByb2plY3RQYXRoICsgXCIvXCIpO1xuICAgICAgICBlbHNlIGlmIChkYlVybE9ycHJvalVybC5zdGFydHNXaXRoKFwicHJvamVjdDovL1wiKSkgcmV0dXJuIGRiVXJsT3Jwcm9qVXJsLnJlcGxhY2UoXCJkYjovL1wiLCB0aGlzLlByb2plY3RQYXRoICsgXCIvXCIpO1xuICAgICAgICBlbHNlIHJldHVybiBkYlVybE9ycHJvalVybDtcbiAgICB9XG5cbiAgICAvKiog57uf5LiA6Lev5b6E5YiG6ZqU56ym5Li6KC8pICovXG4gICAgcHVibGljIHN0YXRpYyB0b1VuaVNlcGFyYXRvcihwYXRoOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIHBhdGgucmVwbGFjZSgvXFxcXC9nLCBcIi9cIik7XG4gICAgfVxuXG4gICAgLyoqIOe7n+S4gOaNouihjOespuS4uihcXG4pICovXG4gICAgcHVibGljIHN0YXRpYyB0b1VuaUxpbmVCcmFrZShjb250ZW50OiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIGNvbnRlbnQucmVwbGFjZSgvXFxcXHJcXFxcbi9nLCBcIlxcblwiKTtcbiAgICB9XG59Il19